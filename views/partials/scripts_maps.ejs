<!-- jQuery -->
<script src="/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- overlayScrollbars -->
<script src="/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="/dist/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->

<script>
  const token = document.getElementById("token").value;
  console.log('token:', token);

  let deviceid;
  let type;

  let map = null;
  let markersLayer = {};

  async function setOption(newId, newType) {

    // sebelum render, bersihkan marker lama sesuai type
    Object.values(markersLayer).forEach(marker => map.removeLayer(marker));
    markersLayer = {};   // reset storage

    console.log('setOption');
    console.log('deviceid:', newId);
    console.log('type:', newType);
    deviceid = newId;
    type = newType;
  }

  async function getLocation() {
    try {
      //console.log('deviceid:', deviceid);
      //console.log('type:', type);
      let result;
      if (type == "all") {
        console.log('getLocation');
        const res = await fetch(`/gps/getMaps`, {
          headers: { Authorization: "Bearer " + token }
        });
        result = await res.json();
      } else if (type == "individu") {
        console.log('getLocation');
        const res = await fetch(`/gps/getDevice/` + deviceid, {
          headers: { Authorization: "Bearer " + token }
        });
        result = await res.json();
      } else if (type == "groups") {
        console.log('getLocation');
        const res = await fetch(`/gps/getMapGroups/` + deviceid, {
          headers: { Authorization: "Bearer " + token }
        });
        result = await res.json();
      }

      const starting_position = result.starting_position;
      const data = result.data;
      //console.log('Data:', data);

      // =============================
      // 1️⃣ INIT MAP (HANYA SEKALI)
      // =============================
      if (!map) {
        const key = 'xETUuAVe5RphO86wCqU2';

        map = L.map('map').setView(starting_position, 14);

        L.tileLayer(
          `https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${key}`,
          {
            tileSize: 512,
            zoomOffset: -1,
            minZoom: 1,
            attribution:
              '&copy; MapTiler &copy; OpenStreetMap contributors',
            crossOrigin: true
          }
        ).addTo(map);
      }
      // =============================
      // 2️⃣ ICON (BISA GLOBAL JUGA)
      // =============================
      const carIcon = L.icon({
        iconUrl: '/images/Top POV.png',
        iconSize: [45, 66],
        iconAnchor: [22.5, 60],
        popupAnchor: [0, -62]
      });

      // =============================
      // 3️⃣ UPDATE / CREATE MARKER
      // =============================

      // bersihkan marker lama kalau type individu
      //if (type === "individu") {
      // Object.values(markersLayer).forEach(marker => map.removeLayer(marker));
      // markersLayer = {};
      //}

      data.forEach(item => {
        const id = item.id;
        const coords = item.coords;
        const popup = item.popup;

        if (markersLayer[id]) {
          markersLayer[id].setLatLng(coords);
        } else {
          markersLayer[id] = L.marker(coords, { icon: carIcon })
            .addTo(map)
            .bindPopup(popup)
            .openPopup();
        }
      });
    } catch (err) {
      console.error("getLocation error:", err);
    }
  }

  let timer1 = null;
  async function getLocationTimer() {
    if (timer1) return; // cegah dobel timer
    timer1 = setInterval(async () => {
      await getLocation();
    }, 2000);
  }

  $(document).ready(async function () {
    await setOption("0", "all");      // initial call
    await getLocationTimer(); // start timer
  });

</script>